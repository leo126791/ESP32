# 🔧 SD 卡故障排除指南

## ❌ 當前錯誤

```
E (5147) sdmmc_sd: sdmmc_init_sd_if_cond: send_if_cond (1) returned 0x108
E (5147) vfs_fat_sdmmc: sdmmc_card_init failed (0x108)
E (5147) SD_CARD: ❌ SD 卡掛載失敗: ESP_ERR_INVALID_RESPONSE (0x108)
```

**錯誤含義**：ESP32 無法與 SD 卡通訊，SD 卡沒有響應。

---

## 🔍 排查步驟

### 步驟 1：檢查 SD 卡本身

#### 1.1 SD 卡是否插好？
- [ ] 取出 SD 卡
- [ ] 檢查金屬觸點是否乾淨
- [ ] 重新插入，確保插到底
- [ ] 聽到「咔」一聲

#### 1.2 SD 卡格式是否正確？
- [ ] 用電腦讀取 SD 卡
- [ ] 右鍵 → 內容 → 檢查格式
- [ ] 必須是 **FAT32**（不是 exFAT 或 NTFS）
- [ ] 如果不是，重新格式化：
  ```
  Windows: 右鍵 → 格式化 → 檔案系統選 FAT32
  ```

#### 1.3 SD 卡容量
- [ ] 容量 ≤ 32GB（FAT32 限制）
- [ ] 如果 > 32GB，需要用特殊工具格式化為 FAT32

#### 1.4 SD 卡品牌
某些 SD 卡與 ESP32 不相容，建議使用：
- ✅ SanDisk
- ✅ Samsung
- ✅ Kingston
- ⚠️ 避免雜牌或假卡

---

### 步驟 2：檢查接線（最重要！）

#### 2.1 接線對照表

```
SD Card 模組    ESP32-S3    說明
─────────────────────────────────────
VCC             3.3V        電源
GND             GND         接地
MISO            GPIO 13     主入從出 ⚠️
MOSI            GPIO 11     主出從入 ⚠️
SCK/CLK         GPIO 12     時鐘
CS              GPIO 10     片選
```

#### 2.2 MISO/MOSI 最容易接反！

**記憶方法**：
- **MISO** = Master **In**, Slave **Out**
  - ESP32 是 Master（主）
  - SD Card 是 Slave（從）
  - 數據從 SD Card **Out** → ESP32 **In**
  - ESP32 **接收**數據

- **MOSI** = Master **Out**, Slave **In**
  - 數據從 ESP32 **Out** → SD Card **In**
  - ESP32 **發送**數據

**測試方法**：
1. 如果當前接線不行
2. **交換 GPIO 11 和 GPIO 13 的接線**
3. 重新測試

#### 2.3 檢查杜邦線

- [ ] 杜邦線是否鬆動？
- [ ] 杜邦線是否損壞？
- [ ] 嘗試更換杜邦線
- [ ] 杜邦線長度 < 20cm

#### 2.4 檢查 SD 卡模組

- [ ] SD 卡模組是否有電源指示燈？
- [ ] 指示燈是否亮起？
- [ ] 模組是否損壞？

---

### 步驟 3：檢查電源

#### 3.1 電壓測試

用萬用表測試：
- [ ] SD Card VCC 是否為 3.3V？
- [ ] 不能是 5V（會損壞 SD 卡）
- [ ] 不能太低（< 3.0V 無法工作）

#### 3.2 電流測試

SD 卡初始化時需要較大電流（~100mA）：
- [ ] ESP32 的 3.3V 輸出是否足夠？
- [ ] 嘗試用外部 3.3V 穩壓模組供電

---

### 步驟 4：軟體測試

#### 4.1 降低 SPI 速度

你的代碼已經設定為 400kHz（最低速度），這應該是最穩定的。

如果還想更低，可以改為：

```c
host.max_freq_khz = 200;  // 降到 200kHz
```

#### 4.2 增加延遲

在 `sd_card_init()` 中，掛載前加延遲：

```c
ESP_LOGI(TAG, "等待 SD 卡穩定...");
vTaskDelay(pdMS_TO_TICKS(1000));  // 等待 1 秒

ret = esp_vfs_fat_sdspi_mount(...);
```

---

## 🧪 測試方法

### 測試 1：交換 MISO/MOSI

**當前接線**：
```
MISO → GPIO 13
MOSI → GPIO 11
```

**改為**：
```
MISO → GPIO 11
MOSI → GPIO 13
```

然後修改代碼：

```c
// main/sd_card_manager.c
#define PIN_NUM_MISO  11  // 原本是 13
#define PIN_NUM_MOSI  13  // 原本是 11
```

重新編譯測試。

### 測試 2：更換 SD 卡

1. 準備另一張 SD 卡
2. 格式化為 FAT32
3. 插入測試

### 測試 3：更換 SD 卡模組

如果有備用的 SD 卡模組，嘗試更換。

---

## 💡 常見原因統計

根據經驗，SD 卡無法讀取的原因：

| 原因 | 機率 | 解決方法 |
|------|------|---------|
| MISO/MOSI 接反 | 40% | 交換接線 |
| SD 卡未插好 | 20% | 重新插入 |
| SD 卡格式錯誤 | 15% | 格式化為 FAT32 |
| 杜邦線接觸不良 | 10% | 更換杜邦線 |
| SD 卡不相容 | 10% | 更換品牌 |
| 硬體損壞 | 5% | 更換模組 |

---

## ⚙️ 暫時禁用 SD 卡

如果 SD 卡不是必需的，可以暫時禁用繼續開發：

### 方法 1：註解初始化代碼（已完成）

`main/hi_esp_keyword.c` 中的 SD 卡初始化已被註解。

### 方法 2：跳過 TTS 下載

TTS 音檔下載也會檢查 SD 卡，確保相關代碼也被註解。

---

## 🎯 建議的測試順序

### 優先級 1：快速測試（5 分鐘）
1. ✅ 重新插入 SD 卡
2. ✅ 交換 MISO/MOSI 接線
3. ✅ 更換杜邦線

### 優先級 2：軟體測試（10 分鐘）
1. ✅ 用電腦檢查 SD 卡格式
2. ✅ 重新格式化為 FAT32
3. ✅ 修改代碼交換 GPIO

### 優先級 3：硬體測試（30 分鐘）
1. ✅ 用萬用表測試電壓
2. ✅ 更換 SD 卡
3. ✅ 更換 SD 卡模組

---

## 📝 測試記錄表

請記錄你的測試結果：

| 測試項目 | 結果 | 備註 |
|---------|------|------|
| SD 卡重新插入 | ⬜ 成功 / ⬜ 失敗 | |
| 檢查格式 FAT32 | ⬜ 是 / ⬜ 否 | |
| 交換 MISO/MOSI | ⬜ 成功 / ⬜ 失敗 | |
| 更換杜邦線 | ⬜ 成功 / ⬜ 失敗 | |
| 測試電壓 3.3V | ⬜ 正常 / ⬜ 異常 | |
| 更換 SD 卡 | ⬜ 成功 / ⬜ 失敗 | |
| 更換模組 | ⬜ 成功 / ⬜ 失敗 | |

---

## 🔄 重新啟用 SD 卡

當問題解決後，取消註解：

```c
// main/hi_esp_keyword.c
// 找到這段代碼並取消註解
ret = sd_card_init();
if (ret != ESP_OK) {
    ESP_LOGW(TAG, "⚠️ SD 卡初始化失敗");
} else {
    ESP_LOGI(TAG, "✅ SD 卡初始化成功");
    sd_list_files();
}
```

---

## 💬 需要幫助？

如果嘗試所有方法都失敗：

1. **拍照接線**：拍下你的接線照片
2. **記錄測試結果**：填寫上面的測試記錄表
3. **提供 SD 卡資訊**：品牌、容量、格式

這樣可以更精確地診斷問題。

---

**目前系統可以正常運行，只是無法使用 SD 卡功能。** ✅
