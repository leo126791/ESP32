# 📌 Hi ESP 語音助手 - 完整接線指南

## 🎯 硬體清單

### 必需硬體
- ESP32-S3-N16R8 開發板（16MB Flash + 8MB PSRAM）
- INMP441 數位麥克風模組
- MAX98357A I2S 功放模組
- 4-8Ω 揚聲器
- microSD 卡（FAT32 格式，建議 ≤ 32GB）
- SD 卡模組（SPI 介面）

### 電源需求
- 5V 電源供應器（建議 2A 以上）
- USB 線（用於燒錄和供電）

### 連接線材
- 杜邦線（公對母、母對母）
- 麵包板（可選，方便接線）

---

## 🔌 詳細接線圖

### 1️⃣ INMP441 數位麥克風

```
┌─────────────────────────────────────────────┐
│ INMP441 模組                                │
├──────────┬──────────────────────────────────┤
│ 引腳     │ 連接到 ESP32-S3                  │
├──────────┼──────────────────────────────────┤
│ VDD      │ 3.3V ⚠️ 不要接 5V！             │
│ GND      │ GND                              │
│ L/R      │ GND (選擇左聲道)                 │
│ WS       │ GPIO 4 (LRCLK/字選擇時鐘) ⭐ 新  │
│ SCK      │ GPIO 5 (BCLK/位時鐘) ⭐ 新       │
│ SD       │ GPIO 6 (DOUT/數據輸出) ⭐ 新     │
└──────────┴──────────────────────────────────┘
```

**重要說明**：
- ⚠️ **VDD 只能接 3.3V**，接 5V 會燒毀麥克風！
- **L/R 引腳接 GND** = 左聲道，接 VDD = 右聲道
- 使用 I2S_NUM_0（I2S 端口 0）
- 採樣率：16kHz，16-bit，單聲道

**接線技巧**：
1. 先接 GND 和 VDD（電源）
2. 再接信號線（WS、SCK、SD）
3. 確保杜邦線長度 < 20cm（減少干擾）
4. 信號線遠離電源線

---

### 2️⃣ MAX98357A 音頻功放

```
┌─────────────────────────────────────────────┐
│ MAX98357A 模組                              │
├──────────┬──────────────────────────────────┤
│ 引腳     │ 連接到 ESP32-S3                  │
├──────────┼──────────────────────────────────┤
│ VIN      │ 5V ⚡ 需要大電流                 │
│ GND      │ GND                              │
│ LRC      │ GPIO 7 (LRCLK/字選擇時鐘) ⭐ 新  │
│ BCLK     │ GPIO 15 (BCLK/位時鐘) ⭐ 新      │
│ DIN      │ GPIO 16 (數據輸入) ⭐ 新         │
│ SD       │ GPIO 17 (開關控制，可選) ⭐ 新   │
│ GAIN     │ 懸空 (預設 9dB 增益)             │
└──────────┴──────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 揚聲器連接                                  │
├──────────┬──────────────────────────────────┤
│ MAX98357A│ 揚聲器                           │
├──────────┼──────────────────────────────────┤
│ +        │ 揚聲器 + (紅線)                  │
│ -        │ 揚聲器 - (黑線)                  │
└──────────┴──────────────────────────────────┘
```

**重要說明**：
- ⚡ **VIN 需要 5V 且電流充足**（建議外部電源 2A+）
- 使用 I2S_NUM_1（I2S 端口 1）
- 支援 4-8Ω 揚聲器
- SD 引腳控制：
  - 接 GPIO 19：可軟體控制開關
  - 接 VIN：永久開啟
  - 懸空：永久開啟

**GAIN 引腳設定**（可選）：
| GAIN 接法 | 增益 |
|-----------|------|
| 懸空 | 9dB (預設) |
| GND | 6dB |
| VIN | 12dB |
| 100K 電阻到 GND | 15dB |

**電源建議**：
- ❌ 不建議：只用 USB 供電（電流不足，音量小或重啟）
- ✅ 建議：使用外部 5V 2A 電源供應器
- ✅ 最佳：使用 5V 3A 電源（音量大且穩定）

---

### 3️⃣ SD 卡模組

```
┌─────────────────────────────────────────────┐
│ SD 卡模組 (SPI 介面)                        │
├──────────┬──────────────────────────────────┤
│ 引腳     │ 連接到 ESP32-S3                  │
├──────────┼──────────────────────────────────┤
│ VCC      │ 3.3V                             │
│ GND      │ GND                              │
│ MISO     │ GPIO 8 (主入從出) ⭐ 新 ⚠️ 易接反│
│ MOSI     │ GPIO 2 (主出從入) ⭐ 新 ⚠️ 易接反│
│ SCK/CLK  │ GPIO 3 (時鐘) ⭐ 新              │
│ CS       │ GPIO 1 (片選) ⭐ 新              │
└──────────┴──────────────────────────────────┘
```

**重要說明**：
- 使用 SPI2_HOST（SPI 端口 2）
- ⚠️ **MISO 和 MOSI 最容易接反**，請仔細檢查！
- SD 卡必須格式化為 **FAT32**
- 支援容量：≤ 32GB（FAT32 限制）
- SPI 速度：400kHz（穩定模式，適合麵包板）

**SD 卡準備**：
1. 用電腦格式化為 FAT32
2. 確認可以正常讀寫
3. 插入 SD 卡模組
4. 確保插緊

**常見問題**：
- 如果 SD 卡初始化失敗，檢查 MISO/MOSI 是否接反
- 如果系統重啟，可能是看門狗超時（參考故障排除）

---

## 🔋 電源配置

### 方案 A：USB 供電（測試用）
```
USB 5V ──┬──→ ESP32-S3 (5V)
         ├──→ ESP32-S3 3.3V ──→ INMP441 (VDD)
         ├──→ ESP32-S3 3.3V ──→ SD Card (VCC)
         └──→ MAX98357A (VIN) ⚠️ 電流可能不足
```

**優點**：方便測試  
**缺點**：MAX98357A 電流不足，音量小或重啟

### 方案 B：外部電源（推薦）
```
外部 5V 2A ──┬──→ ESP32-S3 (5V)
             ├──→ ESP32-S3 3.3V ──→ INMP441 (VDD)
             ├──→ ESP32-S3 3.3V ──→ SD Card (VCC)
             └──→ MAX98357A (VIN) ✅ 電流充足
```

**優點**：穩定，音量大  
**缺點**：需要額外電源

### 共地連接（重要！）
```
ESP32-S3 GND ──┬──→ INMP441 (GND)
               ├──→ MAX98357A (GND)
               ├──→ SD Card (GND)
               └──→ 外部電源 (GND)
```

⚠️ **所有 GND 必須連接在一起！**

---

## 📊 完整接線圖（文字版）

```
                        ESP32-S3-N16R8
                        ┌─────────────┐
         USB/外部5V ────┤ 5V          │
                        │ 3.3V        │
                        │ GND         │
                        │             │
    INMP441             │             │         MAX98357A
    ┌─────┐             │             │         ┌─────────┐
    │ VDD ├─────────────┤ 3.3V        │    ┌────┤ VIN     │
    │ GND ├─────────────┤ GND         │    │    │ GND ────┼──┐
    │ L/R ├─────────────┤ GND         │    │    │ LRC ────┼──┤
    │ WS  ├─────────────┤ GPIO 4  ⭐  │    │    │ BCLK ───┼──┤
    │ SCK ├─────────────┤ GPIO 5  ⭐  │    │    │ DIN ────┼──┤
    │ SD  ├─────────────┤ GPIO 6  ⭐  │    │    │ SD   ───┼──┤
    └─────┘             │             │    │    └─────────┘  │
                        │             │    │                 │
    SD Card             │             │    │    揚聲器       │
    ┌─────┐             │             │    │    ┌────┐      │
    │ VCC ├─────────────┤ 3.3V        │    │    │ +  │      │
    │ GND ├─────────────┤ GND         │    │    │ -  │      │
    │MISO ├─────────────┤ GPIO 13     │    │    └────┘      │
    │MOSI ├─────────────┤ GPIO 11     │    │                 │
    │ CLK ├─────────────┤ GPIO 12     │    │                 │
    │ CS  ├─────────────┤ GPIO 10     │    │                 │
    └─────┘             │             │    │                 │
                        │ GPIO 7  ⭐──┼────┘                 │
                        │ GPIO 15 ⭐──┼────┐                 │
                        │ GPIO 16 ⭐──┼────┤                 │
                        │ GPIO 17 ⭐──┼────┤                 │
                        │             │    │                 │
                        │ 5V ─────────┼────┴─────────────────┘
                        │ GND ────────┼────── GND (共地)
                        └─────────────┘
```

---

## ✅ 接線檢查清單

### 步驟 1：電源連接
- [ ] ESP32-S3 接 5V 電源
- [ ] 所有 GND 連接在一起
- [ ] INMP441 VDD 接 3.3V（不是 5V！）
- [ ] MAX98357A VIN 接 5V
- [ ] SD Card VCC 接 3.3V

### 步驟 2：INMP441 麥克風
- [ ] VDD → 3.3V
- [ ] GND → GND
- [ ] L/R → GND
- [ ] WS → **GPIO 4** ⭐ 新
- [ ] SCK → **GPIO 5** ⭐ 新
- [ ] SD → **GPIO 6** ⭐ 新

### 步驟 3：MAX98357A 功放
- [ ] VIN → 5V
- [ ] GND → GND
- [ ] LRC → **GPIO 7** ⭐ 新
- [ ] BCLK → **GPIO 15** ⭐ 新
- [ ] DIN → **GPIO 16** ⭐ 新
- [ ] SD → **GPIO 17** ⭐ 新（或 VIN）
- [ ] 揚聲器已連接（+ 和 -）

### 步驟 4：SD 卡模組
- [ ] VCC → 3.3V
- [ ] GND → GND
- [ ] MISO → **GPIO 8** ⭐ 新 ⚠️ 檢查是否接反
- [ ] MOSI → **GPIO 2** ⭐ 新 ⚠️ 檢查是否接反
- [ ] CLK → **GPIO 3** ⭐ 新
- [ ] CS → **GPIO 1** ⭐ 新
- [ ] SD 卡已插入並格式化為 FAT32

### 步驟 5：最終檢查
- [ ] 所有連接牢固
- [ ] 沒有短路
- [ ] 電源電壓正確（3.3V 和 5V）
- [ ] 杜邦線長度合理（< 20cm）

---

## 🎨 實體接線建議

### 使用麵包板
```
1. 將 ESP32-S3 插在麵包板中央
2. 左側接 INMP441 和 SD Card
3. 右側接 MAX98357A
4. 電源線用紅色，GND 用黑色
5. 信號線用其他顏色區分
```

### 不使用麵包板
```
1. 直接用杜邦線連接
2. 建議使用母對母杜邦線
3. 用標籤紙標記每條線
4. 整理線材避免纏繞
```

### 線材管理
- 電源線（紅/黑）與信號線分開走線
- I2S 信號線盡量短且平行
- SPI 信號線避免與 I2S 交叉
- 用束線帶或魔鬼氈整理

---

## ⚠️ 常見問題與故障排除

### 問題 1：麥克風沒有聲音
**可能原因**：
- INMP441 VDD 接錯（接到 5V）
- L/R 引腳沒接 GND
- WS 和 SCK 接反
- 杜邦線接觸不良

**解決方法**：
1. 用萬用表測試 INMP441 VDD 是否為 3.3V
2. 確認 L/R 接 GND
3. 重新檢查 GPIO 38、39、37 接線
4. 更換杜邦線

### 問題 2：揚聲器沒有聲音
**可能原因**：
- MAX98357A 電源不足
- SD 引腳沒有啟用
- 揚聲器接反或損壞
- I2S 信號線錯誤

**解決方法**：
1. 使用外部 5V 2A 電源
2. 將 SD 引腳接 VIN 或 GPIO 19
3. 交換揚聲器 + - 試試
4. 檢查 GPIO 16、17、18 接線

### 問題 3：SD 卡無法讀取
**可能原因**：
- MISO 和 MOSI 接反
- SD 卡未格式化為 FAT32
- SD 卡未插好
- SPI 速度太快

**解決方法**：
1. 交換 MISO (GPIO 13) 和 MOSI (GPIO 11)
2. 用電腦格式化 SD 卡為 FAT32
3. 重新插入 SD 卡
4. 已設定為 400kHz（穩定模式）

### 問題 4：系統不穩定或重啟
**可能原因**：
- 電源電流不足
- 看門狗超時
- 記憶體不足

**解決方法**：
1. 使用外部 5V 2A+ 電源
2. 參考 `SIMPLE_SOLUTION.md`（已減少錄音時間到 2 秒）
3. 檢查 PSRAM 是否啟用（應該有 8189 KB）

### 問題 5：雜音或干擾
**可能原因**：
- 信號線太長
- 信號線與電源線平行
- 接地不良

**解決方法**：
1. 縮短杜邦線長度（< 20cm）
2. 信號線與電源線分開走線
3. 確保所有 GND 連接良好
4. 在電源加濾波電容（100μF + 0.1μF）

---

## 🧪 測試步驟

### 1. 上電測試
```bash
# 連接 USB，觀察串口輸出
idf.py -p COM3 monitor
```

預期輸出：
```
I (xxx) HI_ESP_KEYWORD: ✅ INMP441 初始化成功
I (xxx) HI_ESP_KEYWORD: ✅ SD 卡初始化成功
I (xxx) HI_ESP_KEYWORD: ✅ 音頻輸出初始化成功
I (xxx) HI_ESP_KEYWORD: 🎤 開始監聽 'Hi ESP'...
```

### 2. 麥克風測試
對著麥克風說話，觀察能量值：
```
I (xxx) HI_ESP_KEYWORD: 📊 能量: 1850000 (閾值: 150000)
```

如果能量值 > 150000，表示麥克風正常。

### 3. 關鍵詞測試
清楚地說 "Hi ESP"，應該觸發錄音：
```
I (xxx) HI_ESP_KEYWORD: 🔊 檢測到 'Hi ESP'！
I (xxx) HI_ESP_KEYWORD: 🎙️  開始錄音...
```

### 4. 揚聲器測試
系統啟動時會播放提示音（嗶嗶聲）。

### 5. SD 卡測試
檢查串口輸出：
```
I (xxx) SD_CARD: ✅ SD 卡掛載成功: /sdcard
I (xxx) SD_CARD: SD 卡容量: XXX MB
```

---

## 📝 GPIO 使用總覽

| GPIO | 功能 | 模組 | 方向 | 電壓 | 狀態 |
|------|------|------|------|------|------|
| 1 | SPI CS | SD Card | 輸出 | 3.3V | ⭐ 新 |
| 2 | SPI MOSI | SD Card | 輸出 | 3.3V | ⭐ 新 |
| 3 | SPI CLK | SD Card | 輸出 | 3.3V | ⭐ 新 |
| 4 | I2S0 WS | INMP441 | 輸出 | 3.3V | ⭐ 新 |
| 5 | I2S0 BCK | INMP441 | 輸出 | 3.3V | ⭐ 新 |
| 6 | I2S0 SD | INMP441 | 輸入 | 3.3V | ⭐ 新 |
| 7 | I2S1 WS | MAX98357A | 輸出 | 3.3V | ⭐ 新 |
| 8 | SPI MISO | SD Card | 輸入 | 3.3V | ⭐ 新 |
| 15 | I2S1 BCK | MAX98357A | 輸出 | 3.3V | ⭐ 新 |
| 16 | I2S1 DIN | MAX98357A | 輸出 | 3.3V | ⭐ 新 |
| 17 | SD Control | MAX98357A | 輸出 | 3.3V | ⭐ 新 |

**剩餘可用 GPIO**：0, 9, 10, 11, 12, 13, 14, 18, 19, 20, 21, 38, 39, 40, 41, 42, 47, 48

---

## 🎯 專案功能

### 已啟用功能
- ✅ WiFi 連接（硬編碼 SSID/密碼）
- ✅ 位置服務（IP 定位）
- ✅ INMP441 麥克風錄音（16kHz, 16-bit）
- ✅ 關鍵詞檢測 "Hi ESP"
- ✅ 音頻上傳到服務器（STT 語音識別）
- ✅ MAX98357A 音頻輸出
- ✅ SD 卡支援（保存/播放 WAV 文件）
- ✅ PSRAM 支援（8MB）
- ✅ DSP 音訊處理（濾波、增益）

### 錄音參數
- 採樣率：16kHz
- 位深度：16-bit
- 聲道：單聲道
- 錄音時長：3 秒
- 緩衝區：96KB（使用 PSRAM）

---

**接線完成後，執行以下命令測試：**

```bash
idf.py build
idf.py -p COM3 flash monitor
```

**祝你接線順利！** 🎉
